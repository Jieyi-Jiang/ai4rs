from mmengine.config import read_base
with read_base():
    from .rtdetr_o_r50vd_8xb2_72e_dior import *

pretrained = ('https://www.modelscope.cn/models/wokaikaixinxin/ai4rs/resolve/'
              'master/rtdetr/resnet18vd_pretrained_55f5a0d6.pth')  # noqa
model.update(
    backbone=dict(
        depth=18,
        frozen_stages=-1,
        norm_cfg=dict(requires_grad=True),
        norm_eval=False,
        init_cfg=dict(type='Pretrained', checkpoint=pretrained)),
    neck=dict(in_channels=[128, 256, 512]),
    encoder=dict(fpn_cfg=dict(expansion=0.5)),
    decoder=dict(num_layers=3))

# set all norm layers in backbone to lr_mult=0.1 and decay_mult=0.0
# set all other layers in backbone to lr_mult=0.1
num_blocks_list = (2, 2, 2, 2)  # r18
downsample_norm_idx_list = (2, 3, 3, 3)  # r18
backbone_norm_multi = dict(lr_mult=0.1, decay_mult=0.0)
custom_keys = {
    'backbone': dict(lr_mult=0.1), 'in_proj_bias': dict(decay_mult=0)}
custom_keys.update({
    'backbone.stem.1': backbone_norm_multi,
    'backbone.stem.4': backbone_norm_multi,
    'backbone.stem.7': backbone_norm_multi,
})
custom_keys.update({
    f'backbone.layer{stage_id + 1}.{block_id}.bn': backbone_norm_multi
    for stage_id, num_blocks in enumerate(num_blocks_list)
    for block_id in range(num_blocks)
})
custom_keys.update({
    f'backbone.layer{stage_id + 1}.{block_id}.downsample.{downsample_norm_idx - 1}':  # noqa
    backbone_norm_multi
    for stage_id, (num_blocks, downsample_norm_idx) in enumerate(
        zip(num_blocks_list, downsample_norm_idx_list))
    for block_id in range(num_blocks)
})

# optimizer
optim_wrapper.paramwise_cfg.pop('custom_keys')
optim_wrapper.update(
    paramwise_cfg=dict(custom_keys=dict(**custom_keys)))